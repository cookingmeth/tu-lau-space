<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Auth0 Authentication -->
  <script>
    // Auth0 configuration from environment variables (injected at build time)
    const AUTH0_DOMAIN = {{ getenv "AUTH0_DOMAIN" | default "" | jsonify }};
    const AUTH0_CLIENT_ID = {{ getenv "AUTH0_CLIENT_ID" | default "" | jsonify }};
    const AUTH0_REDIRECT_URI = {{ getenv "AUTH0_REDIRECT_URI" | default "" | jsonify }};

    console.log('Auth0 Config Debug:', {
      domain: AUTH0_DOMAIN,
      clientId: AUTH0_CLIENT_ID,
      redirectUri: AUTH0_REDIRECT_URI
    });

    // Validate environment variables are set
    function validateConfig() {
      const missingVars = [];
      if (!AUTH0_DOMAIN || AUTH0_DOMAIN.trim() === '') {
        missingVars.push('AUTH0_DOMAIN');
      }
      if (!AUTH0_CLIENT_ID || AUTH0_CLIENT_ID.trim() === '') {
        missingVars.push('AUTH0_CLIENT_ID');
      }
      if (!AUTH0_REDIRECT_URI || AUTH0_REDIRECT_URI.trim() === '') {
        missingVars.push('AUTH0_REDIRECT_URI');
      }
      return missingVars;
    }

    const missingVars = validateConfig();

    if (missingVars.length > 0) {
      // Show error message if environment variables are not configured
      document.body.innerHTML = `
        <div style="font-family: system-ui, -apple-system, sans-serif; max-width: 700px; margin: 50px auto; padding: 20px; background: #fee; border: 2px solid #c33; border-radius: 8px;">
          <h1 style="color: #c33; margin-top: 0;">⚠️ Configuration Error</h1>
          <p><strong>The following Auth0 environment variables are not configured:</strong></p>
          <ul style="background: white; padding: 15px 15px 15px 35px; border-radius: 4px; font-family: monospace;">
            ${missingVars.map(v => `<li>${v}</li>`).join('')}
          </ul>
          <p>To fix this issue:</p>
          <ol style="line-height: 1.6;">
            <li>Go to your <a href="https://app.netlify.com" target="_blank">Netlify dashboard</a></li>
            <li>Navigate to <strong>Site settings → Environment variables</strong></li>
            <li>Add the missing environment variables:
              <ul style="margin-top: 10px;">
                <li><code>AUTH0_DOMAIN</code> - Your Auth0 domain (e.g., <code>dev-xxxxx.auth0.com</code>)</li>
                <li><code>AUTH0_CLIENT_ID</code> - Your Auth0 client ID (public value, safe for frontend)</li>
                <li><code>AUTH0_REDIRECT_URI</code> - Your admin callback URL (e.g., <code>https://tulau.space/admin/</code>)</li>
              </ul>
            </li>
            <li><strong>IMPORTANT:</strong> Do NOT mark <code>AUTH0_CLIENT_ID</code> and <code>AUTH0_REDIRECT_URI</code> as "secret" - they need to be available during Hugo build</li>
            <li>Set the scope to <strong>"Builds, Deployments, and Functions"</strong> (NOT "Runtime-only")</li>
            <li>Trigger a new deploy after saving the variables</li>
          </ol>
          <p style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 4px; margin-top: 15px;">
            <strong>⚠️ Common Issue:</strong> If you're seeing this error after setting the environment variables,
            make sure they are <strong>not marked as "secret"</strong> and are available during <strong>"Builds"</strong>.
            Secret variables are not accessible to Hugo during the build process.
          </p>
          <p style="margin-bottom: 0;"><small>See <code>DECAP_CMS_SETUP.md</code> for detailed setup instructions.</small></p>
        </div>
      `;
      console.error('Auth0 configuration error: Missing environment variables:', missingVars);
      return;
    }

    const auth0Config = {
      domain: AUTH0_DOMAIN,
      clientId: AUTH0_CLIENT_ID,
      authorizationParams: {
        redirect_uri: AUTH0_REDIRECT_URI
      }
    };

    let auth0Client;

    async function initAuth0() {
      try {
        auth0Client = await auth0.createAuth0Client(auth0Config);

        // Check if we're returning from Auth0 redirect
        const query = window.location.search;
        if (query.includes('code=') && query.includes('state=')) {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, '/admin/');
        }

        // Check if user is authenticated
        const isAuthenticated = await auth0Client.isAuthenticated();

        if (!isAuthenticated) {
          // Redirect to Auth0 login
          await auth0Client.loginWithRedirect();
        } else {
          // User is authenticated, get user info and token
          const user = await auth0Client.getUser();
          const token = await auth0Client.getTokenSilently();

          console.log('Authenticated user:', user);

          // Initialize CMS with authenticated user
          // Note: Decap CMS will still need git-gateway or GitHub backend configured
        }
      } catch (error) {
        console.error('Auth0 initialization error:', error);

        // Show user-friendly error message
        document.body.innerHTML = `
          <div style="font-family: system-ui, -apple-system, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; background: #fee; border: 2px solid #c33; border-radius: 8px;">
            <h1 style="color: #c33; margin-top: 0;">⚠️ Authentication Error</h1>
            <p><strong>Unable to initialize Auth0 authentication.</strong></p>
            <p>Error: ${error.message || 'Unknown error'}</p>
            <p>Please contact the site administrator.</p>
            <details style="margin-top: 20px; background: white; padding: 10px; border-radius: 4px;">
              <summary style="cursor: pointer; font-weight: bold;">Technical Details</summary>
              <pre style="overflow: auto; font-size: 12px; margin-top: 10px;">${error.stack || error.toString()}</pre>
            </details>
          </div>
        `;
      }
    }

    // Initialize Auth0 when page loads
    initAuth0();
  </script>
</body>
</html>
