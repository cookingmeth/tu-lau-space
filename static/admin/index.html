<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Auth0 Authentication -->
  <script>
    const auth0Config = {
      domain: 'dev-faxa6osmu4ax2y1m.auth0.com',
      clientId: '1cOyuBuM1flVAtUuUNncyMGfhMDXuVmq',
      authorizationParams: {
        redirect_uri: 'https://tulau.space/admin/'
      }
    };

    let auth0Client;

    async function initAuth0() {
      try {
        auth0Client = await auth0.createAuth0Client(auth0Config);

        // Check if we're returning from Auth0 redirect
        const query = window.location.search;
        if (query.includes('code=') && query.includes('state=')) {
          await auth0Client.handleRedirectCallback();
          window.history.replaceState({}, document.title, '/admin/');
        }

        // Check if user is authenticated
        const isAuthenticated = await auth0Client.isAuthenticated();

        if (!isAuthenticated) {
          // Redirect to Auth0 login
          await auth0Client.loginWithRedirect();
        } else {
          // User is authenticated, get user info and token
          const user = await auth0Client.getUser();
          const token = await auth0Client.getTokenSilently();

          console.log('Authenticated user:', user);

          // Initialize CMS with authenticated user
          // Note: Decap CMS will still need git-gateway or GitHub backend configured
        }
      } catch (error) {
        console.error('Auth0 initialization error:', error);
      }
    }

    // Initialize Auth0 when page loads
    initAuth0();
  </script>
</body>
</html>
